# F103KIT
Отладочная плата F103_KIT c контроллером STM32f103VE.
* LCD модуль со встроенным контроллером SSD1963 управление
по 16 битной шине (RGB565) через встроенный модуль контроллера FSMC в режиме PSRAM.
* Тач контроллер TSC2046 через SPI2 (stm32) частота spi интерфейса 1,125MHz.
* Heap emWin располагается во внутренней SRAM (38 * 1024 байт) и адрес определяются линкером при сборке.
* Все битмапы иконок храняться во внутренней flash и адреса определяются линкером при сборке.
* sd карта подключена по 4-х битному интерфейсу SDIO  SDIOCLK=(48MHz) / 2=24MHz.
Карта работает через DMA2_Channel4. Один на прием и на передачу. Драйвер карты настроен на байтную адресацию (SDSC 1,2 Gb).
* Поверх функций чтения/записи сектора реализованы функции disc_read disc_write из библиотеки FATFs (Chan's).
Вся работа с картой чтение запись файлов посредством файловой системы FATFS.
* Библиотека TJPGLib (Chan's) для открывания файлов jpeg c sd-карты. Для работы десомпрессора реализованы две callback функции.
in_func() для считывания очередной порции данных в буфер (8192 байта) .  out_funk() для вывода  на экран этой порции после 
обработки декомпрессором.
* Настроен модуль для приема сообщений по CAN сети (CAN1). Частота 125 KHz Sample point=75%. Транссивер CAN шины
SN65HVD230.
* На таймере TIM2 сделан модуль управления тиристором для регулирования мощности нагрузки (нагреватель).
2 режима работы таймера фазовый и по методу брезенхема.Таймер в режиме One pulse mode.Длительность импульса для открывания
тиристора 300 мкс.
  * Фазовый реализует изменение фазы включения тиристора на каждом полупериоде
сетевого напряжения изменяя мощность нагрузки 0-100% с шагом 1%. Таймер запускается  по сигналу с детектора перехода 
"фазы" через "ноль". В таком режиме таймер генерит импульсы  автономно без прерываний.
  * Брезенхема реализует изменение мощности путем пропусков целых периодов синусойды сетевого напряжения.
Для этого включается прерывание для таймера по событию capture от детектора "фазы через ноль".
Через биты IC1PSC регистра CCMR1 прерывание по захвату срабатывает на каждом втором импульсе.Таким
образом  делается пропуск целых периодов синусойды для регулирования. Мощность регулируется 0-100 %
но в таком режиме шаг равен 2% (50 делений по мощности).
* 13.03.17. Добавил взможность обновления прошивки по CAN сети в режиме приложения. Управляющий MCU присылает запрос 
на обновление в виде сообщения id=371 UPDATE_FIRMWARE_REQ сообщение содержит размер бинарника который сохраняется в size_firmware. Далее разблокируется флэш если надо очищаются необходимае сектора (с адреса NAMBER_UPD_PAGE) и отправляется подтверждение на выдачу данных
  * ID=(NETNAME_INDEX<<8)|0x72
  * CAN_Data_TX.Data[0]=NETNAME_INDEX
  * CAN_Data_TX.Data[1]='g'	GET_DATA.
* Далее принимаются сообщения по 8 байт прошивки для обновления с индексом id=373 DOWNLOAD_FIRMWARE и записываются во вторую половину флэш. После принятия всех байт проверяется целостность записанной прошивки crc32_check() и выдаются сообщение содержащее CAN_Data_TX.Data[1]='c' если CRC_OK! или CAN_Data_TX.Data[1]='e' если CRC_ERROR! Выставляется флаг write_flashflag=1 если CRC_OK! В сеторе FLAG_STATUS_PAGE перебираются байты пока не будет найдено чистое поле 0xFFFF. В этом байте пишется флаг 0x00A7 для бутлодера, который перепишет обновление в рабочую часть флэш и сделает запуск приложения. После секндной паузы делается RESET для запуска бутлоадера.

* Для получения готового bin файла делается последовательность:
  * $K\ARM\ARMCC\BIN\fromelf.exe --bin -o F103_KIT.bin !L  получаем из .axf бинарник .bin
  * srec_cat F103_KIT.bin -bin -exclude 0x1C 0x28 -length-l-e 0x1C 4 -generate 0x20 0x28 -repeat-string F103_KIT -o F103_KIT.bin -bin -
  исключаем из бинарника адреса с 0x1C до 0x28 по адресу 0x1c записываем 4 байта размер бинарника. По адресу 0x20 8 байт строки "F103_KIT"
   * srec_cat F103_KIT.bin -bin -crc32-l-e  -max-addr F103_KIT.bin -bin -o F103_KIT.bin - считаем crc32 для полученного бинарника
   и сохраняем его в конце файла  F103_KIT.bin.
